<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mueblería Hermanos</title>
    <style>
        :root{
            --purple: #7b2bd4;
            --light-bg: #f6f6f6;
            --card-shadow: rgba(0,0,0,0.18);
        }
        html,body{height:100%;}
        body{
            margin:0;
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: var(--light-bg);
            -webkit-font-smoothing:antialiased;
            display:flex;
            flex-direction:column;
            align-items:stretch;
        }
        /* grid background */
        :root{--footer-height:56px}
        .page{
            flex:1;
            background-image:
                linear-gradient(#e6e6e6 1px, transparent 1px),
                linear-gradient(90deg,#e6e6e6 1px, transparent 1px);
            background-size:64px 64px,64px 64px;
            padding:28px 36px 92px 36px; /* espacio inferior para el footer */
            box-sizing:border-box;
        }
        header{
            background:var(--purple);
            color:white;
            padding:22px 16px;
            border-radius:4px;
            text-align:center;
            box-shadow:0 2px 0 rgba(0,0,0,0.05) inset;
            font-size:32px;
            font-weight:700;
        }
        .content{
            display:flex;
            align-items:center;
            justify-content:center;
            gap:48px;
            margin-top:56px;
            margin-bottom:48px;
        }
        .card{
            width:320px;
            height:140px;
            border-radius:18px;
            display:flex;
            align-items:center;
            justify-content:center;
            color:white;
            font-size:26px;
            font-weight:600;
            box-shadow:0 10px 18px var(--card-shadow);
            padding:16px;
            text-align:center;
            cursor:pointer;
            user-select:none;
        }
        .card[role="button"]:focus{outline:3px solid rgba(123,43,212,0.18)}
        .card--muebles{ background: #c6a7f0; color: #fff; }
        .card--variantes{ background: #9fe6c5; color: #fff; }
        .card--cotizaciones{ background: #f2a1b6; color: #fff; }
        footer{
            --h:var(--footer-height);
            background:var(--purple);
            color:white;
            padding:12px 16px;
            text-align:center;
            font-weight:600;
            height:var(--h);
            line-height:32px;
            position:fixed;
            left:0;right:0;bottom:0;
            z-index:30;
        }

        /* slide-up panel above footer */
        .panel{
            position:fixed;
            left:50%;
            transform:translateX(-50%) translateY(110%);
            bottom:calc(var(--footer-height) + 12px);
            width:calc(100% - 72px);
            max-width:1200px;
            height:420px;
            background:#fff;
            border-radius:8px;
            box-shadow:0 18px 40px rgba(0,0,0,0.25);
            transition:transform .35s cubic-bezier(.2,.9,.2,1);
            overflow:auto;
            z-index:40;
        }
        .panel.open{ transform:translateX(-50%) translateY(0); }
        .panel-header{
            background:var(--panel-accent, var(--purple));
            color:#fff;
            padding:14px 18px;
            font-size:22px;
            font-weight:700;
            display:flex;
            align-items:center;
            justify-content:space-between;
            border-radius:6px 6px 0 0;
        }
        .panel-body{ padding:14px 18px 28px 18px; }
        .panel .btn{ padding:8px 12px; border-radius:8px; border:none; cursor:pointer }
        .close-btn{ background:#fff;color:var(--purple); border:2px solid rgba(255,255,255,0.18); font-weight:700 }
        .create-btn{ background:#2fd79b; color:#fff; padding:10px 14px; border-radius:10px; border:none; font-weight:700 }
        .create-btn--purple{ background:var(--purple); color:#fff; padding:10px 14px; border-radius:10px; border:none; font-weight:700 }
        .create-btn--accent{ background:var(--panel-accent); color:#fff; padding:10px 14px; border-radius:10px; border:none; font-weight:700 }

        /* table styles */
        .admin-table{ width:100%; border-collapse:collapse; font-size:15px }
        .admin-table thead th{ background:rgba(0,0,0,0.06); padding:14px; text-align:left }
        .admin-table tbody td{ padding:12px; border-top:1px solid #eee }
        .pill{ padding:6px 10px; border-radius:6px; background:#e9e9e9; display:inline-block }
        .action-btn{ padding:6px 10px; border-radius:8px; border:none; margin-left:6px }
        .action-edit{ background:#9fd7a8 }
        .action-del{ background:#6e5f6f; color:#fff }
        .action-confirm{ background:#2eaf4a; color:#fff }
        
        /* form styles */
        .form-input{ padding:8px; border:1px solid #ddd; border-radius:4px; font-size:14px; font-family:inherit; }
        .form-input:focus{ outline:2px solid #7b2bd4; outline-offset:-1px; }
        .submit-btn:hover{ opacity:0.9; }
        .cancel-btn:hover{ opacity:0.8; }
        
        /* responsive */
        @media (max-width:980px){
            .content{ flex-direction:column; gap:22px; }
            .card{ width:80%; }
        }
    </style>
</head>
<body>
    <div class="page">
        <header>Mueblería Hermanos</header>

        <div class="content" role="main" aria-label="Acciones principales">
            <div class="card card--muebles" role="button" tabindex="0" data-panel="muebles">Administrar<br> Muebles</div>
            <div class="card card--variantes" role="button" tabindex="0" data-panel="variantes">Administrar<br> Variantes</div>
            <div class="card card--cotizaciones" role="button" tabindex="0" data-panel="cotizaciones">Administrar<br> Cotizaciones</div>
        </div>

        <footer>Programador: Carlos Orellana</footer>
    </div>

    <!-- panel inferior -->
    <div id="panel" class="panel" aria-hidden="true">
        <div class="panel-header">
            <div id="panel-title">Administración</div>
            <div>
                <button id="panel-close" class="btn close-btn">Cerrar ✕</button>
            </div>
        </div>
        <div class="panel-body" id="panel-body">
            <!-- contenido por defecto: tabla de muebles -->
            <h3 style="margin-top:0">Administración de Muebles</h3>
            <table class="admin-table" aria-describedby="panel-title">
                <thead>
                    <tr>
                        <th>id</th>
                        <th>nombre</th>
                        <th>tipo</th>
                        <th>precio base</th>
                        <th>stock</th>
                        <th>activo</th>
                        <th>material</th>
                        <th>Administración</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1</td>
                        <td>Sillón Modular</td>
                        <td>Salón</td>
                        <td>$949.99</td>
                        <td>15</td>
                        <td><span class="pill">✓</span></td>
                        <td>Madera</td>
                        <td>
                            <button class="action-btn action-del">Eliminar</button>
                            <button class="action-btn action-edit">Editar</button>
                        </td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>Cama Queen</td>
                        <td>Mader/Metal</td>
                        <td>$799.00</td>
                        <td>22</td>
                        <td><span class="pill">✓</span></td>
                        <td>Melamina</td>
                        <td>
                            <button class="action-btn action-del">Eliminar</button>
                            <button class="action-btn action-edit">Editar</button>
                        </td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>Silla Ergonómica</td>
                        <td>Office</td>
                        <td>$299.75</td>
                        <td>120</td>
                        <td><span class="pill">✓</span></td>
                        <td>Plástico / Malla</td>
                        <td>
                            <button class="action-btn action-del">Eliminar</button>
                            <button class="action-btn action-edit">Editar</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Cargar configuración de puerto dinámico generada por Java -->
    <script src="env.js" onerror="console.log('Modo Docker o env.js no encontrado')"></script>

    <script>
        (function(){
            const panel = document.getElementById('panel');
            const panelTitle = document.getElementById('panel-title');
            const panelBody = document.getElementById('panel-body');
            const closeBtn = document.getElementById('panel-close');

            // Función para detectar la URL del Backend automáticamente
            function getBaseUrl() {
                // MODO LOCAL: Si abres el archivo directo (file://) -> Usa el puerto dinámico de env.js
                if (window.location.protocol === 'file:') {
                    return 'http://localhost:' + (window.BACKEND_PORT || 8080);
                }
                // MODO DOCKER: Si estás en localhost:3000 -> Conecta al contenedor app (8080)
                if (window.location.port === '3000') {
                    return window.location.protocol + '//' + window.location.hostname + ':8080';
                }
                // OTROS (Ej. Live Server): Por defecto intentamos el 8080 o el que definas
                return window.location.protocol + '//' + window.location.hostname + ':' + (window.BACKEND_PORT || 8080);
            }

            function openPanel(title, html){
                panelTitle.textContent = title;
                if(html) panelBody.innerHTML = html;
                panel.classList.add('open');
                panel.setAttribute('aria-hidden','false');
            }
            function closePanel(){
                panel.classList.remove('open');
                panel.setAttribute('aria-hidden','true');
            }

            // function to build muebles table from API data
            async function loadAndShowMuebles(){
                const purple = getComputedStyle(document.documentElement).getPropertyValue('--purple').trim() || '#7b2bd4';
                panel.style.setProperty('--panel-accent', purple);
                
                try {
                    const baseUrl = getBaseUrl();
                    const response = await fetch(baseUrl + '/api/muebles');
                    
                    if(!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const muebles = await response.json();
                    
                    const rows = muebles.map(m => `
                        <tr>
                            <td>${m.id_mueble || 'N/A'}</td>
                            <td>${m.nombre || ''}</td>
                            <td>${m.tipo || ''}</td>
                            <td>$${(m.precio_base || 0).toFixed(2)}</td>
                            <td>${m.stock || 0}</td>
                            <td><span class="pill">${m.activo ? '✓' : '✗'}</span></td>
                            <td>${m.material || ''}</td>
                            <td>
                                <button class="action-btn action-del" data-id="${m.id_mueble}" data-action="delete">Eliminar</button>
                                <button class="action-btn action-edit" data-id="${m.id_mueble}" data-action="edit">Editar</button>
                            </td>
                        </tr>`).join('\n');
                    
                    const mueblesHtml = `
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                            <div></div>
                            <button class="create-btn--purple" data-show="form-muebles">Crear Mueble</button>
                        </div>
                        <div id="form-muebles" style="display:none;background:#f9f9f9;padding:12px;border-radius:6px;margin-bottom:12px;border:1px solid #e0e0e0;">
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;">
                                <input type="text" class="form-input" placeholder="Nombre" data-field="nombre" />
                                <input type="text" class="form-input" placeholder="Tipo" data-field="tipo" />
                                <input type="number" class="form-input" placeholder="Precio Base" data-field="precio_base" step="0.01" />
                                <input type="number" class="form-input" placeholder="Stock" data-field="stock" />
                                <select class="form-input" data-field="activo">
                                    <option value="true">Activo: Sí</option>
                                    <option value="false">Activo: No</option>
                                </select>
                                <input type="text" class="form-input" placeholder="Material" data-field="material" />
                            </div>
                            <div style="display:flex;gap:8px;margin-top:12px;">
                                <button class="submit-btn" data-action="submit-mueble" style="flex:1;background:#7b2bd4;color:white;border:none;padding:8px;border-radius:4px;cursor:pointer;">Guardar</button>
                                <button class="cancel-btn" data-action="cancel" style="flex:1;background:#ccc;border:none;padding:8px;border-radius:4px;cursor:pointer;">Cancelar</button>
                            </div>
                        </div>
                        <table class="admin-table" aria-describedby="panel-title">
                            <thead>
                                <tr>
                                    <th>id</th>
                                    <th>nombre</th>
                                    <th>tipo</th>
                                    <th>precio base</th>
                                    <th>stock</th>
                                    <th>activo</th>
                                    <th>material</th>
                                    <th>Administración</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                    `;
                    openPanel('Administración de Muebles', mueblesHtml);
                    
                    // Agregar event listeners al formulario
                    setupFormHandlers('muebles');
                } catch(err){
                    console.error('Error cargando muebles:', err);
                    const errorMsg = `<p style="color:red">Error: ${err.message}<br/>Asegúrate de que el backend esté corriendo en puerto 8080</p>`;
                    openPanel('Administración de Muebles', errorMsg);
                }
            }

            // function to build variantes table from API data
            async function loadAndShowVariantes(){
                panel.style.setProperty('--panel-accent', '#0CF9AD');
                
                try {
                    const baseUrl = getBaseUrl();
                    const response = await fetch(baseUrl + '/api/variantes');
                    
                    if(!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const variantes = await response.json();
                    
                    const rows = variantes.map(v => `
                        <tr>
                            <td>${v.id_variante || 'N/A'}</td>
                            <td>${v.nombre_variante || ''}</td>
                            <td>$${(v.precio_adicional || 0).toFixed(2)}</td>
                            <td>
                                <button class="action-btn action-del" data-id="${v.id_variante}" data-action="delete">Eliminar</button>
                                <button class="action-btn action-edit" data-id="${v.id_variante}" data-action="edit">Editar</button>
                            </td>
                        </tr>`).join('\n');
                    
                    const variantesHtml = `
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                            <div></div>
                            <button class="create-btn--green" data-show="form-variantes">Crear Nueva Variante</button>
                        </div>
                        <div id="form-variantes" style="display:none;background:#f9f9f9;padding:12px;border-radius:6px;margin-bottom:12px;border:1px solid #e0e0e0;">
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;">
                                <input type="number" class="form-input" placeholder="ID Mueble" data-field="id_mueble" />
                                <input type="text" class="form-input" placeholder="Nombre" data-field="nombre" />
                                <input type="number" class="form-input" placeholder="Precio Adicional" data-field="precio_adicional" step="0.01" />
                            </div>
                            <div style="display:flex;gap:8px;margin-top:12px;">
                                <button class="submit-btn" data-action="submit-variantes" style="flex:1;background:#0CF9AD;color:#000;border:none;padding:8px;border-radius:4px;cursor:pointer;">Guardar</button>
                                <button class="cancel-btn" data-action="cancel" style="flex:1;background:#ccc;border:none;padding:8px;border-radius:4px;cursor:pointer;">Cancelar</button>
                            </div>
                        </div>
                        <table class="admin-table" aria-describedby="panel-title">
                            <thead>
                                <tr>
                                    <th>id</th>
                                    <th>nombre</th>
                                    <th>precio adicional</th>
                                    <th>Administración</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                    `;
                    openPanel('Administración de Variantes', variantesHtml);
                    setupFormHandlers('variantes');
                } catch(err){
                    console.error('Error cargando variantes:', err);
                    const errorMsg = `<p style="color:red">Error: ${err.message}<br/>Asegúrate de que el backend esté corriendo en puerto 8080</p>`;
                    openPanel('Administración de Variantes', errorMsg);
                }
            }

            // function to build cotizaciones table from API data
            async function loadAndShowCotizaciones(){
                const cotCard = document.querySelector('.card--cotizaciones');
                const cotBg = cotCard ? getComputedStyle(cotCard).backgroundColor : '#f2a1b6';
                panel.style.setProperty('--panel-accent', cotBg);
                
                try {
                    const baseUrl = getBaseUrl();
                    const response = await fetch(baseUrl + '/api/cotizaciones');
                    
                    if(!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const cotizaciones = await response.json();
                    
                    const rows = cotizaciones.map(c => {
                        const actions = [];
                        if(c.estado === 'Pendiente'){
                            actions.push(`<button class="action-btn action-confirm" data-id="${c.id_cotizacion}" data-action="confirm">Confirmar</button>`);
                        }
                        actions.push(`<button class="action-btn action-del" data-id="${c.id_cotizacion}" data-action="cancel">Cancelar</button>`);
                        if(c.estado !== 'Confirmada'){
                            actions.push(`<button class="action-btn action-edit" data-id="${c.id_cotizacion}" data-action="edit">Editar</button>`);
                        }
                        return `
                            <tr>
                                <td>${c.id_cotizacion || 'N/A'}</td>
                                <td>${c.fecha_cotizacion ? new Date(c.fecha).toLocaleDateString('es-ES') : 'N/A'}</td>
                                <td>$${(c.calculoTotal || 0).toFixed(2)}</td>
                                <td>${c.estado || 'Pendiente'}</td>
                                <td>${actions.join('')}</td>
                            </tr>`;
                    }).join('\n');
                    
                    const cotizacionesHtml = `
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                            <div></div>
                            <button class="create-btn--accent" data-show="form-cotizaciones">Crear Cotización</button>
                        </div>
                        <div id="form-cotizaciones" style="display:none;background:#f9f9f9;padding:12px;border-radius:6px;margin-bottom:12px;border:1px solid #e0e0e0;">
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;">
                                <input type="date" class="form-input" placeholder="Fecha" data-field="fecha" />
                                <input type="number" class="form-input" placeholder="Total" data-field="total" step="0.01" />
                                <select class="form-input" data-field="estado">
                                    <option value="Pendiente">Pendiente</option>
                                    <option value="Confirmada">Confirmada</option>
                                    <option value="Cancelada">Cancelada</option>
                                </select>
                            </div>
                            <div style="display:flex;gap:8px;margin-top:12px;">
                                <button class="submit-btn" data-action="submit-cotizaciones" style="flex:1;background:#f2a1b6;color:#000;border:none;padding:8px;border-radius:4px;cursor:pointer;">Guardar</button>
                                <button class="cancel-btn" data-action="cancel" style="flex:1;background:#ccc;border:none;padding:8px;border-radius:4px;cursor:pointer;">Cancelar</button>
                            </div>
                        </div>
                        <table class="admin-table" aria-describedby="panel-title">
                            <thead>
                                <tr>
                                    <th>id</th>
                                    <th>fecha</th>
                                    <th>total</th>
                                    <th>estado</th>
                                    <th>Administración</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                    `;
                    openPanel('Administración de Cotizaciones', cotizacionesHtml);
                    setupFormHandlers('cotizaciones');
                } catch(err){
                    console.error('Error cargando cotizaciones:', err);
                    const errorMsg = `<p style="color:red">Error: ${err.message}<br/>Asegúrate de que el backend esté corriendo en puerto 8080</p>`;
                    openPanel('Administración de Cotizaciones', errorMsg);
                }
            }

            // handlers for cards
            document.querySelectorAll('.card[role="button"]').forEach(el=>{
                el.addEventListener('click', ()=>{
                    const target = el.getAttribute('data-panel');
                    if(target === 'muebles'){
                        loadAndShowMuebles();
                    } else if(target === 'variantes'){
                        loadAndShowVariantes();
                    } else if(target === 'cotizaciones'){
                        loadAndShowCotizaciones();
                    }
                });
                el.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' ') el.click(); });
            });

            
            // Setup form handlers for create/cancel buttons
            function setupFormHandlers(type){
                const formId = `form-${type}`;
                const form = document.getElementById(formId);
                if(!form) return;
                
                // Toggle form visibility
                const createBtn = document.querySelector(`[data-show="${formId}"]`);
                if(createBtn){
                    createBtn.addEventListener('click', ()=>{
                        form.style.display = form.style.display === 'none' ? 'block' : 'none';
                    });
                }
                
                // Cancel button
                const cancelBtn = form.querySelector('[data-action="cancel"]');
                if(cancelBtn){
                    cancelBtn.addEventListener('click', ()=>{
                        form.style.display = 'none';
                        form.querySelectorAll('.form-input').forEach(inp => inp.value = '');
                    });
                }
                
                // Submit button
                const submitBtn = form.querySelector('[data-action^="submit"]');
                if(submitBtn){
                    submitBtn.addEventListener('click', async ()=>{
                        const fields = {};
                        form.querySelectorAll('.form-input').forEach(inp => {
                            fields[inp.dataset.field] = inp.value;
                        });
                        
                        // Validate empty fields
                        if(Object.values(fields).some(v => !v)){
                            alert('Por favor completa todos los campos');
                            return;
                        }
                        
                        await submitFormData(type, fields);
                    });
                }
            }
            
            // Submit form data to backend
            async function submitFormData(type, fields){
                const baseUrl = getBaseUrl();
                const endpoints = {
                    muebles: '/api/muebles',
                    variantes: '/api/variantes',
                    cotizaciones: '/api/cotizaciones'
                };
                
                try {
                    const response = await fetch(baseUrl + endpoints[type], {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(fields)
                    });
                    
                    if(!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    alert('Registro creado exitosamente');
                    document.getElementById(`form-${type}`).style.display = 'none';
                    
                    // Reload table
                    if(type === 'muebles') loadAndShowMuebles();
                    else if(type === 'variantes') loadAndShowVariantes();
                    else if(type === 'cotizaciones') loadAndShowCotizaciones();
                } catch(err){
                    alert('Error al crear registro: ' + err.message);
                    console.error(err);
                }
            }

            closeBtn.addEventListener('click', closePanel);
            // click outside panel to close
            window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closePanel(); });
        })();
    </script>
</body>
</html>
